@using Microsoft.AspNetCore.Identity
@using ProductionLibrary
@inject UserManager<User> userManager

@*@{
    var user = await userManager.GetUserAsync(User);
    var userId = user?.Id;
}*@
@model Production





<h4>Welcome to @Model.ProductionName</h4>
<h2>Here are your units:</h2>

@if (Model.Rooms.Count() == 0)
{
    <h3>U need to create your first unit</h3>

    <a asp-controller="Room" asp-action="Create" asp-route-productionId="@Model.Id" class="btn btn-primary">New Unit</a>

}
else
{
    foreach (var room in Model.Rooms)
    {

        <table class="table mb-0">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">@room.RoomName (@room.Lots.Count())</th>
                    <th><a asp-controller="Lot" asp-action="Create" asp-route-roomId="@room.Id" asp-route-productionId="@room.ProductionId" class="btn btn-primary">Add lot</a></th>
                    <th><a asp-controller="Room" asp-action="Delete" asp-route-id="@room.Id" asp-route-prodId="@room.ProductionId" class="btn btn-danger">X</a></th>
                </tr>
            </thead>
        </table>
        if (room.Lots.Count() == 0)
        {
            <table class="table">
                <thead class="bg-danger">
                    <tr>
                        <th>@room.RoomName is empty</th>
                    </tr>
                </thead>
            </table>
        }
        else
        {
            <table class="table table-bordered">
                <thead class="bg-secondary">
                    <tr>
                        <th width="20%">Lot Reference</th>
                        <th width="20%">Product</th>
                        <th width="20%">Estimation</th>
                        <th width="20%">Recolted</th>
                        <th width="20%">Options</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var lot in room.Lots)
                    {
                        <tr class="bg-primary">
                            <td>@lot.Reference</td>
                            <td>@lot.ProductName</td>
                            <td>@lot.EstimatedQuantitie (@lot.UnitType)</td>
                            <td>@lot.RecoltedQuantitie (@lot.UnitType)</td>
                            <td>
                                <div>
                                    <a asp-controller="Lot" asp-action="Collect" asp-route-lotId="@lot.Id" asp-route-productionId="@Model.Id" class="btn btn-success">Collect</a>
                                    <a asp-controller="Lot" asp-action="Delete" asp-route-lotId="@lot.Id" asp-route-productionId="@Model.Id" class="btn btn-danger">X</a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }
    <a asp-controller="Room" asp-action="Create" asp-route-productionId="@Model.Id" class="btn btn-primary">Create new unit</a>
}
<hr />
<h2>@Model.ProductionName' avaiable missions</h2>
@if (Model.ProdTasks.Count() == 0)
{
    <h3>No avaiable missions curently</h3>
    <a asp-controller="ProdTask" asp-action="Create" asp-route-productionId="@Model.Id" class="btn btn-primary">New Mission</a>
}
else
{
    <table class="table table-bordered mt-2">
        <thead>
            <tr>
                <th width="100%" class="h2 text-center border-white border-top-0 coltitle">Avaiable missions(@Model.ProdTasks.Where(t => t.ProdTaskStatusId == 1 && t.ProductionId == Model.Id).Count())</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="bg-primary">
                    @foreach (var prodTask in Model.ProdTasks.OrderBy(p => p.ProdTaskStatusId).Where(t => (t.ProdTaskStatusId == 1 || t.ProdTaskStatusId == 2) && t.ProductionId == Model.Id))
                    {
                        if (prodTask.ProdTaskStatusId == 1)
                        {

                            <div class="card border bodyground my-2 bg-warning" width="100%">
                                <div class="card-body">
                                    <h5 class="card-title">@prodTask.TaskName</h5>
                                    <hr>
                                    <pre readonly class="card-text">@prodTask.TaskDescription</pre>
                                    <hr>
                                    <h5 style="color: blueviolet">Assigned:</h5>
                                    @foreach (var prodTaskUsers in prodTask.ProdTaskUsers.Where(p => p.ProdTaskId == prodTask.Id))
                                    {
                                        <div>@prodTaskUsers.UserName</div>
                                    }
                                    <a asp-controller="ProdTask" asp-action="AssignProdTask" asp-route-id="@prodTask.Id" asp-route-productionId="@Model.Id" class="btn btn-primary">Take Mission</a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="card border bodyground my-2" width="100%">
                                <div class="card-body">
                                    <h5 class="card-title">@prodTask.TaskName</h5>
                                    <hr>
                                    <pre readonly class="card-text">@prodTask.TaskDescription</pre>
                                    <hr>
                                    <h5 style="color: blueviolet">Assigned:</h5>
                                    @foreach (var prodTaskUsers in prodTask.ProdTaskUsers.Where(p => p.ProdTaskId == prodTask.Id))
                                    {
                                        <div class="assigned mt-3">@prodTaskUsers.UserName</div>
                                    }

                                    @{var t = prodTask.ProdTaskUsers.Where(p => p.ProdTaskId == prodTask.Id && p.UserId == @userManager.GetUserId(User));}
                                    @if (t.Count() == 0)
                                    {
                                        <a asp-controller="ProdTask" asp-action="AssignProdTask" asp-route-id="@prodTask.Id" asp-route-productionId="@Model.Id" class="btn btn-primary mt-4">Take Mission</a>
                                    }
                                    else
                                    {
                                        <a asp-controller="ProdTask" asp-action="AssignProdTask" asp-route-id="@prodTask.Id" asp-route-productionId="@Model.Id" class="btn btn-danger mt-4">Remove Mission</a>
                                    }
                                </div>
                            </div>
                        }
                    }
                </td>

            </tr>
        </tbody>
    </table>

    <a asp-controller="ProdTask" asp-action="Create" asp-route-productionId="@Model.Id" class="btn btn-primary">New Mission</a>
}